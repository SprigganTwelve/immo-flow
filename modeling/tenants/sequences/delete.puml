@startuml
title "Sequence Diagram: Delete Tenant"

skinparam actorStyle awesome
actor UI

participant "TenantDomain" as Domain
participant "AuthDomain" as AuthDomain
participant "AuthService" as AuthService
participant "SecurityDomain" as SecurityDomain
participant "LogDomain" as LogDomain
participant "LogRepository" as LogRepo
participant "EmailDomain" as EmailDomain
participant "TenantRepository" as TenantRepo
database "Database" as DB



UI -> Domain : delete(id, token)
activate Domain



Domain -> AuthDomain : authorize(token)
activate AuthDomain



AuthDomain -> AuthService : validate(token)
activate AuthService



note right of AuthService
  - validate token
  - decode claims
  - verify signature
end note


AuthService --> AuthDomain : authResult
deactivate AuthService




alt Authorize

    AuthDomain --> Domain : authorized
    deactivate AuthDomain

    Domain -> TenantRepo : terminateTenant(id)
    activate TenantRepo

    TenantRepo -> DB : UPDATE tenant status
    activate DB
    DB --> TenantRepo : ok
    deactivate DB

    alt termination ok
        TenantRepo --> Domain : success
        Domain --> UI : success
    else termination failed
        TenantRepo --> Domain : failure
        Domain --> UI : failed
    end

    deactivate TenantRepo


else Unauthorized

    AuthDomain --> Domain : rejected
    deactivate AuthDomain

    Domain -> SecurityDomain : handleAuthFailure(context)
    activate SecurityDomain

    SecurityDomain -> LogDomain : recordUnauthorizedAccess()
    activate LogDomain

    LogDomain -> LogRepo : save(event)
    activate LogRepo

    LogRepo -> DB : INSERT security_log
    activate DB
    DB --> LogRepo : ok
    deactivate DB

    LogRepo --> LogDomain : ok
    deactivate LogRepo

    LogDomain --> SecurityDomain : recorded
    deactivate LogDomain

    SecurityDomain -> EmailDomain : sendWarningIfNeeded()
    ref over EmailDomain
        Send warning email to landlord
    end ref

    EmailDomain --> SecurityDomain : sent
    SecurityDomain --> Domain : handled
    deactivate SecurityDomain

    Domain --> UI : <<warning>> unauthorized request
    
end

deactivate Domain
@enduml
