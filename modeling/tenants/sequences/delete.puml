@startuml

title "DELETE TENANT"

skinparam actorStyle awesome
actor UI

participant "TenantDomain" as Domain
participant "AuthDomain" as AuthDomain
participant "AuthService" as Auth
participant "EmailDomain" as EmailDomain
participant "EmailService" as Email
participant "TenantRepository" as Repo
database "Database" as DB



UI -> Domain : delete(id, token)
activate Domain


Domain -> AuthDomain : authorize(token)
activate AuthDomain

AuthDomain -> Auth: validate(token)
activate Auth


note right of Auth
  - token valid
  - policy ok
  - permissions ok
  - host not blacklisted
  - failed attempts < 3
end note

Auth --> AuthDomain: reponse
deactivate Auth


alt authorized

    AuthDomain --> Domain : authorized
    deactivate Auth
    deactivate AuthDomain

    Domain -> Repo : deleteTenant(id)
    activate Repo
    Repo -> DB : DELETE tenant
    activate DB
    DB --> Repo : ok
    deactivate DB

    alt delete ok
        Repo --> Domain : success
        deactivate Repo
        Domain --> UI : success
    else delete failed
        Repo --> Domain : failure
        Domain --> UI : failed
    end
    deactivate Repo

else unauthorized
    Auth --> Domain : rejected
    deactivate Auth

    '====================
    ' Security log
    '====================
    Domain -> Repo : logSecurityFailure()
    activate Repo
    Repo -> DB : INSERT security_log
    activate DB
    DB --> Repo : ok
    deactivate DB
    Repo --> Domain: ok
    deactivate Repo

    '====================
    ' Notification
    '====================

    Domain -> EmailDomain : sendWarning
    ref over EmailDomain
            Send warning email  to landlord
    end ref
    EmailDomain --> Domain: ok

    Domain --> UI : <<warning>> unauthorized request
end

deactivate Domain

@enduml
