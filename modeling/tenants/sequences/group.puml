@startuml
title "Sequence Diagram: Create Tenant Group"

skinparam actorStyle awesome
actor UI

participant "TenantGroupDomain"   as Domain
participant "AuthDomain"          as AuthDomain
participant "AuthService"         as AuthService
participant "SecurityDomain"      as SecurityDomain
participant "LogDomain"           as LogDomain
participant "LogRepository"       as LogRepo
participant "EmailDomain"         as EmailDomain
participant "TenantGroup"         as Group
participant "TenantGroupRepository" as Repo
database "Database"               as DB

UI -> Domain : createGroup(ids, leader, token)
activate Domain

'====================
' Authorization
'====================
Domain -> AuthDomain : authorize(token)
activate AuthDomain

AuthDomain -> AuthService : validate(token)
activate AuthService

note right of AuthService
  - validate token
  - check permissions
  - check policy
end note

AuthService --> AuthDomain : authResult
deactivate AuthService

alt Authorized
    AuthDomain --> Domain : authorized
    deactivate AuthDomain

    '====================
    ' Create group
    '====================
    Domain -> Group : <<create>>(ids, leader)

    note over Group
        Creation may fail if:
        - invalid tenant IDs
        - leader not in group
    end note

    alt Group created
        Group --> Domain : instance

        Domain -> Repo : save(group)
        activate Repo

        Repo -> DB : INSERT tenant_group
        activate DB
        DB --> Repo : ok
        deactivate DB

        Repo --> Domain : ok
        deactivate Repo

        Domain --> UI : group created

    else Creation failed
        Group --> Domain : error
        Domain --> UI : validation error
    end

else Unauthorized
    AuthDomain --> Domain : rejected
    deactivate AuthDomain

    '====================
    ' Security handling
    '====================
    Domain -> SecurityDomain : handleUnauthorizedAccess(context)
    activate SecurityDomain

    SecurityDomain -> LogDomain : recordFailure()
    activate LogDomain

    LogDomain -> LogRepo : save(event)
    activate LogRepo

    LogRepo -> DB : INSERT security_log
    activate DB
    DB --> LogRepo : ok
    deactivate DB

    LogRepo --> LogDomain : ok
    deactivate LogRepo

    LogDomain --> SecurityDomain : recorded
    deactivate LogDomain

    '====================
    ' Notification
    '====================
    SecurityDomain -> EmailDomain : sendWarningIfNeeded()
    ref over EmailDomain
        Send warning email to landlord
    end ref

    EmailDomain --> SecurityDomain : sent
    deactivate SecurityDomain

    Domain --> UI : <<warning>> unauthorized action
end

deactivate Domain
@enduml
