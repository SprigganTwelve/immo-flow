@startuml
title "Sequence Diagram: Retrieve Tenant(s)"

skinparam actorStyle awesome
actor UI

participant "TenantDomain"        as Domain
participant "AuthDomain"          as AuthDomain
participant "AuthService"         as AuthService
participant "SecurityDomain"      as SecurityDomain
participant "LogDomain"           as LogDomain
participant "LogRepository"       as LogRepo
participant "EmailDomain"         as EmailDomain
participant "TenantRepository"    as TenantRepo
database "Database"               as DB



UI -> Domain : retrieveTenants(token)
activate Domain

'====================
' Authorization
'====================


Domain -> AuthDomain : authorize(token)
activate AuthDomain


AuthDomain -> AuthService : validate(token)
activate AuthService


note right of AuthService
  - validate token
  - check signature
  - decode claims
end note

AuthService --> AuthDomain : authResult
deactivate AuthService



alt Authorized
    AuthDomain --> Domain : authorized
    deactivate AuthDomain

    '====================
    ' Retrieve tenants
    '====================
    Domain -> TenantRepo : findAll() / findOne()
    activate TenantRepo

    TenantRepo -> DB : SELECT tenant(s)
    activate DB
    DB --> TenantRepo : tenant(s)
    deactivate DB

    TenantRepo --> Domain : tenant(s)
    deactivate TenantRepo

    Domain --> UI : tenants list

else Unauthorized
    AuthDomain --> Domain : rejected
    deactivate AuthDomain

    '====================
    ' Security handling
    '====================
    Domain -> SecurityDomain : handleAuthFailure(context)
    activate SecurityDomain

    SecurityDomain -> LogDomain : recordUnauthorizedAccess()
    activate LogDomain

    LogDomain -> LogRepo : save(event)
    activate LogRepo

    LogRepo -> DB : INSERT security_log
    activate DB
    DB --> LogRepo : ok
    deactivate DB

    LogRepo --> LogDomain : ok
    deactivate LogRepo

    LogDomain --> SecurityDomain : recorded
    deactivate LogDomain

    '====================
    ' Notification
    '====================
    SecurityDomain -> EmailDomain : sendWarningIfNeeded()
    ref over EmailDomain
        Send warning email to landlord
    end ref

    EmailDomain --> SecurityDomain : sent
    deactivate SecurityDomain

    Domain --> UI : <<warning>> unauthorized request
end

deactivate Domain
@enduml
